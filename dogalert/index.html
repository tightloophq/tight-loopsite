
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dog Alert LIVE</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='12' ry='12' fill='%23ff7a00'/%3E%3Ctext x='50' y='62' font-size='64' text-anchor='middle' fill='white'%3E!%3C/text%3E%3C/svg%3E">

  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#0f1115; color:#fff; display:flex; height:100vh; }
    #sidebar { width:320px; background:#14171c; padding:15px; display:flex; flex-direction:column; overflow-y:auto; }
    #map { flex:1; }
    h1 { font-size:20px; margin:0 0 15px; color:#ff7a00; }
    h2 { font-size:16px; margin:20px 0 5px; color:#ccc; }
    select, textarea, input { width:100%; margin-bottom:10px; padding:8px; border-radius:4px; border:none; }
    button { width:100%; padding:10px; background:#ff7a00; color:#111; border:none; border-radius:4px; cursor:pointer; font-weight:800; }
    button:hover { background:#e65c00; }
    .status { margin-top:8px; font-size:14px; padding:6px; border-radius:4px; background:#1c1f26; }
    .upgrade { margin-top:20px; padding:12px; background:#1a1d23; border-radius:6px; text-align:center; }
    .upgrade h3 { margin:0 0 10px; }
    .upgrade a { display:inline-block; margin-top:8px; padding:8px 12px; border-radius:4px; text-decoration:none; font-weight:800; }
    .btn-basic { background:#4aa8ff; color:#000; }
    .btn-pro { background:#16c784; color:#000; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>üêæ Dog Alert <span style="font-size:12px;color:#aaa;">LIVE</span></h1>

    <h2>Report a Dog</h2>
    <form id="reportForm">
      <select id="type" required>
        <option value="">Select type</option>
        <option value="Aggressive">Aggressive</option>
        <option value="Loose">Loose</option>
        <option value="Suspicious">Suspicious</option>
      </select>
      <select id="breed" required>
        <option value="">Select breed</option>
        <option value="Pit Bull">Pit Bull</option>
        <option value="Rottweiler">Rottweiler</option>
        <option value="German Shepherd">German Shepherd</option>
        <option value="Labrador">Labrador</option>
        <option value="Husky">Husky</option>
        <option value="Other / Unknown">Other / Unknown</option>
      </select>
      <textarea id="desc" placeholder="Color, behavior, collar, direction..." rows="3"></textarea>
      <input type="text" id="lat" placeholder="Latitude (auto if empty)" />
      <input type="text" id="lng" placeholder="Longitude (auto if empty)" />
      <button type="submit">Post Report</button>
    </form>

    <h2>Status</h2>
    <div class="status">Map: <span id="status-map">loading‚Ä¶</span></div>
    <div class="status">Firestore: <span id="status-firestore">loading‚Ä¶</span></div>
    <div class="status">Live pins: <span id="status-pins">0</span></div>

    <div class="upgrade">
      <h3>Dog Alert Basic ¬∑ $4.99/mo</h3>
      <p>Remove ads. Support the network. Early features.</p>
      <a class="btn-basic" href="https://buy.stripe.com/test_5kQ3cveQYgMD9IzdPW9oc00" target="_blank" rel="noopener">Buy Basic</a>
    </div>
    <div class="upgrade">
      <h3>Dog Alert Pro ¬∑ $9.99/mo</h3>
      <p>Priority alerts, advanced filters, map export.</p>
      <a class="btn-pro" href="https://buy.stripe.com/test_6oU14nbEMeEv9Iz4fm9oc0" target="_blank" rel="noopener">Buy Pro</a>
    </div>
  </div>

  <div id="map"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD0MJBsX37dCTMP0pj0WMsMHR6__g_Wa-w",
      authDomain: "dog-alert-39ea0.firebaseapp.com",
      projectId: "dog-alert-39ea0",
      storageBucket: "dog-alert-39ea0.appspot.com",
      messagingSenderId: "569616949041",
      appId: "1:569616949041:web:5c9d94b2002ada585fda10",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map, tempMarker = null, userMarker = null, markers = [];
    const setStatus = (id, t) => {
      const el = document.getElementById(id);
      if (el) el.textContent = t;
    };

    // Expose callback for Google Maps
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 52.7575, lng: -108.2861 },
        zoom: 13
      });
      setStatus("status-map", "ready ‚úÖ");

      // GPS green dot
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          userMarker = new google.maps.Marker({
            position: { lat, lng }, map, title: "You are here",
            icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" }
          });
        });
      }

      // Click map ‚Üí fill lat/lng + blue temp marker
      map.addListener("click", (e) => {
        const lat = e.latLng.lat(), lng = e.latLng.lng();
        document.getElementById("lat").value = lat.toFixed(6);
        document.getElementById("lng").value = lng.toFixed(6);
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({
          position: { lat, lng }, map, title: "New report location",
          icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
        });
      });

      // Live Firestore pins
      const reportsRef = collection(db, "reports");
      onSnapshot(reportsRef, (snap) => {
        markers.forEach((m)=>m.setMap(null)); markers = [];
        let count = 0;
        snap.forEach((doc) => {
          const d = doc.data();
          if (typeof d.lat !== "number" || typeof d.lng !== "number") return;
          const marker = new google.maps.Marker({
            position: { lat: d.lat, lng: d.lng },
            map,
            title: `${d.type || "Report"} - ${d.breed || "Unknown"}`
          });
          const when = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "just now";
          const info = new google.maps.InfoWindow({
            content: `
              <div style="font-size:14px;min-width:220px">
                <div style="font-weight:800">${d.type || "Report"}</div>
                <div style="color:#98a2b3;font-size:12px;margin:4px 0">${d.breed || "Unknown"} ‚Ä¢ ${when}</div>
                <div>${(d.desc || "No description").replace(/</g,"&lt;")}</div>
                <div style="color:#98a2b3;font-size:12px;margin-top:6px">(${d.lat.toFixed(5)}, ${d.lng.toFixed(5)})</div>
              </div>`
          });
          marker.addListener("click", () => info.open(map, marker));
          markers.push(marker);
          count++;
        });
        setStatus("status-pins", String(count));
        setStatus("status-firestore", "connected ‚úÖ");
      });

      // Form submit ‚Üí Firestore
      const form = document.getElementById("reportForm");
      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const type  = document.getElementById("type").value || "Unknown";
        const breed = document.getElementById("breed").value || "Unknown";
        const desc  = document.getElementById("desc").value || "";
        const lat = parseFloat(document.getElementById("lat").value) || map.getCenter().lat();
        const lng = parseFloat(document.getElementById("lng").value) || map.getCenter().lng();

        try {
          await addDoc(collection(db, "reports"), { type, breed, desc, lat, lng, createdAt: serverTimestamp() });
          alert("Report submitted!");
          form.reset();
          if (tempMarker) { tempMarker.setMap(null); tempMarker = null; }
        } catch (err) {
          console.error("Save failed:", err);
          setStatus("status-firestore", "save failed ‚ùå");
        }
      });
    };
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2VhW6QuHIwEXeP1uB7ARYl-0J3OolOec&callback=initMap&loading=async"
    async defer></script>
</body>
</html>
